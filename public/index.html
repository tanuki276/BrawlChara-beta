<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brawlchara</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" href="/public/32×32.png" type="image/png" sizes="32×32" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    #betaNotice {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 10px 16px;
      margin-bottom: 12px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.95rem;
      max-width: 480px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    #tokenList code {
      display: inline-block;
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }

    #disclaimer {
      color: #6b0000;
      font-weight: 600;
      font-size: 0.8rem;
      background: #fff5f5;
      padding: 5px 10px;
      border: 1px solid #d48b8b;
      border-radius: 4px;
      margin-bottom: 8px;
      max-width: 320px;
      line-height: 1.2;
      user-select: none;
    }

    button.loading {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #cookieConsent {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #333;
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      font-size: 1rem;
      font-family: 'Arial', sans-serif;
      animation: fadeIn 0.5s ease-in-out;
    }

    #cookieConsent .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    #cookieConsent button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.2s, opacity 0.2s;
    }

    #cookieConsent button:hover {
      transform: scale(1.05);
      opacity: 0.95;
    }

    #cookieConsent button.no {
      background-color: #f44336;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div id="betaNotice">⚠ このツールは現在<strong>ベータ版</strong>です。不具合や変更の可能性があります。</div>

  <p id="disclaimer">
    ※このツールはBrawlStars公式のものではありません。非公式のファンメイドツールです。
  </p>
  <h1>
    <i class="fa-solid fa-user-ghost"></i>Brawlchara
  </h1>
  <label for="expires">トークン有効期限を選択:</label>
  <select id="expires">
    <option value="3600">1時間</option>
    <option value="86400">24時間</option>
    <option value="604800">7日間</option>
    <option value="0">無制限</option>
  </select>
  <button id="generateToken"><i class="fa-solid fa-key"></i> トークン生成</button>
  <button id="copyToken" disabled><i class="fa-regular fa-copy"></i> トークンをコピー</button>
  <p>生成されたトークン:</p>
  <textarea id="tokenOutput" rows="4" cols="60" readonly></textarea>
  <h2>生成済みトークン一覧</h2>
  <ul id="tokenList">
    <li>トークンがありません</li>
  </ul>
  <h2>キャラを取得</h2>
  <button id="getCharacter"><i class="fa-solid fa-dice-d20"></i> 試す</button>
  <pre id="characterResult"></pre>
  <h2><i class="fa-solid fa-book"></i> ドキュメントはこちらから</h2>
  <p>
    <a href="https://document-api-brawl-chara.vercel.app/" target="_blank" rel="noopener noreferrer">マニュアルを見る</a>
  </p>
  <p>
    <a href="https://a-b-c.vercel.app/" target="_blank" rel="noopener noreferrer">お問い合わせ</a>
  </p>
  <div id="cookieConsent">
    当サイトはクッキーを使用します。同意しますか？
    <div class="button-container">
      <button id="acceptCookie">同意する</button>
      <button id="declineCookie" class="no">拒否する</button>
    </div>
  </div>
  <script>
    const generateBtn = document.getElementById('generateToken');
    const copyBtn = document.getElementById('copyToken');
    const output = document.getElementById('tokenOutput');
    const tokenList = document.getElementById('tokenList');
    const expiresSelect = document.getElementById('expires');

    const characterResult = document.getElementById('characterResult');
    const getCharacterBtn = document.getElementById('getCharacter');

    generateBtn.addEventListener('click', async () => {
      generateBtn.disabled = true;
      generateBtn.classList.add('loading');
      generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 生成中…';

      const expires = parseInt(expiresSelect.value);

      try {
        const res = await fetch('/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ expires })
        });
        const data = await res.json();
        if (res.ok) {
          output.value = data.token;
          copyBtn.disabled = false;
          updateTokenList();
        } else {
          alert(data.error || 'トークン生成に失敗しました');
        }
      } catch (err) {
        alert('通信エラーが発生しました');
      }

      generateBtn.disabled = false;
      generateBtn.classList.remove('loading');
      generateBtn.innerHTML = '<i class="fa-solid fa-key"></i> トークン生成';
    });

    copyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(output.value).then(() => {
        copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> コピー完了';
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i> トークンをコピー';
        }, 1500);
      });
    });

    async function updateTokenList() {
      const res = await fetch('/api/token');
      const data = await res.json();
      tokenList.innerHTML = '';
      if (data.length === 0) {
        tokenList.innerHTML = '<li>トークンがありません</li>';
      } else {
        data.forEach((t) => {
          const li = document.createElement('li');
          const code = document.createElement('code');
          code.textContent = t.token;
          li.appendChild(code);
          const span = document.createElement('span');
          span.textContent = `（${new Date(t.expiresAt).toLocaleString()}まで）`;
          li.appendChild(span);
          tokenList.appendChild(li);
        });
      }
    }

    getCharacterBtn.addEventListener('click', async () => {
      getCharacterBtn.disabled = true;
      getCharacterBtn.classList.add('loading');
      getCharacterBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 読み込み中…';

      try {
        const res = await fetch('/api/character');
        const data = await res.json();
        characterResult.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        characterResult.textContent = 'キャラの取得に失敗しました';
      }

      getCharacterBtn.disabled = false;
      getCharacterBtn.classList.remove('loading');
      getCharacterBtn.innerHTML = '<i class="fa-solid fa-dice-d20"></i> 試す';
    });

    // Cookie consent
    const cookieConsent = document.getElementById('cookieConsent');
    const acceptBtn = document.getElementById('acceptCookie');
    const declineBtn = document.getElementById('declineCookie');

    if (!localStorage.getItem('cookieConsent')) {
      cookieConsent.style.display = 'block';
    }

    acceptBtn.addEventListener('click', () => {
      localStorage.setItem('cookieConsent', 'accepted');
      cookieConsent.style.display = 'none';
    });

    declineBtn.addEventListener('click', () => {
      localStorage.setItem('cookieConsent', 'declined');
      cookieConsent.style.display = 'none';
    });

    // 初期化
    updateTokenList();
  </script>
</body>
</html>